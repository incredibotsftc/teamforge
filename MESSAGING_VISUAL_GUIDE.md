# ğŸ“± Messaging Feature - Visual Reference Guide

## User Interface Layout

### Desktop View
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dashboard Header (with Messaging in sidebar)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                             â”‚                                 â”‚
â”‚  Channels Sidebar           â”‚  Chat Area                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Channels      [+]   â”‚   â”‚  â”‚ #general                    â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚  â”‚ General discussion           â”‚â”‚
â”‚  â”‚ ğŸŸ¢ # general        â”‚   â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ â—‹  # announcements  â”‚   â”‚  â”‚                             â”‚â”‚
â”‚  â”‚ â—‹  # random         â”‚   â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚â”‚
â”‚  â”‚ â—‹  # tech-talk      â”‚   â”‚  â”‚ â”‚ User Avatar â”‚ Alice Smith â”‚â”‚
â”‚  â”‚                     â”‚   â”‚  â”‚ â”‚             â”‚ 5 min ago   â”‚â”‚
â”‚  â”‚                     â”‚   â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚â”‚
â”‚  â”‚                     â”‚   â”‚  â”‚ Hey everyone!               â”‚â”‚
â”‚  â”‚                     â”‚   â”‚  â”‚ Check out this document     â”‚â”‚
â”‚  â”‚                     â”‚   â”‚  â”‚ [Document Preview]          â”‚â”‚
â”‚  â”‚                     â”‚   â”‚  â”‚ ğŸ‘ 2                        â”‚â”‚
â”‚  â”‚                     â”‚   â”‚  â”‚                             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚â”‚
â”‚                             â”‚  â”‚ â”‚ User Avatar â”‚ Bob Johnson â”‚â”‚
â”‚                             â”‚  â”‚ â”‚             â”‚ 2 min ago   â”‚â”‚
â”‚                             â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚â”‚
â”‚                             â”‚  â”‚ Looks good!                 â”‚â”‚
â”‚                             â”‚  â”‚                             â”‚â”‚
â”‚                             â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚                             â”‚  â”‚ [ğŸ“] [Message Input...] [â¤] â”‚â”‚
â”‚                             â”‚  â”‚ Type @ to mention someone   â”‚â”‚
â”‚                             â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                             â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Mobile View
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dashboard Header             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              â”‚
â”‚  Channels View (Modal)       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Channels        [+]    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ # general        â–º Chatâ”‚  â”‚
â”‚  â”‚ # announcements  â–º Chatâ”‚  â”‚
â”‚  â”‚ # random         â–º Chatâ”‚  â”‚
â”‚  â”‚ # tech-talk      â–º Chatâ”‚  â”‚
â”‚  â”‚                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         OR

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â—„ #general                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              â”‚
â”‚  Chat Area (Full Width)      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Alice Smith      5 min â”‚  â”‚
â”‚  â”‚ Hey everyone!          â”‚  â”‚
â”‚  â”‚ Check this out!        â”‚  â”‚
â”‚  â”‚ [Image Preview]        â”‚  â”‚
â”‚  â”‚ ğŸ‘ 2                   â”‚  â”‚
â”‚  â”‚                        â”‚  â”‚
â”‚  â”‚ Bob Johnson      2 min â”‚  â”‚
â”‚  â”‚ Looks great!           â”‚  â”‚
â”‚  â”‚                        â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ [ğŸ“] [Message...] [â¤]  â”‚  â”‚
â”‚  â”‚ Type @ to mention      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Hierarchy

```
MessagingPage
â”œâ”€â”€ DashboardLayout (wrapper)
â”‚   â””â”€â”€ messaging/page.tsx
â”‚       â”œâ”€â”€ ChannelList
â”‚       â”‚   â”œâ”€â”€ Channel list
â”‚       â”‚   â”œâ”€â”€ Create Channel dialog
â”‚       â”‚   â”‚   â”œâ”€â”€ Input: channel name
â”‚       â”‚   â”‚   â””â”€â”€ Textarea: description
â”‚       â”‚   â””â”€â”€ Select channel handler
â”‚       â”‚
â”‚       â””â”€â”€ Main Chat Area
â”‚           â”œâ”€â”€ Channel Header
â”‚           â”‚   â”œâ”€â”€ Back button (mobile only)
â”‚           â”‚   â”œâ”€â”€ Channel name & icon
â”‚           â”‚   â””â”€â”€ Channel description
â”‚           â”‚
â”‚           â”œâ”€â”€ MessageList
â”‚           â”‚   â”œâ”€â”€ Message (x N)
â”‚           â”‚   â”‚   â”œâ”€â”€ Avatar
â”‚           â”‚   â”‚   â”œâ”€â”€ Author name & time
â”‚           â”‚   â”‚   â”œâ”€â”€ Message content
â”‚           â”‚   â”‚   â”œâ”€â”€ Attachments (if any)
â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ Images (inline)
â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ Videos (with player)
â”‚           â”‚   â”‚   â”‚   â””â”€â”€ Files (download)
â”‚           â”‚   â”‚   â”œâ”€â”€ Reactions (if any)
â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ‘ 2
â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ â¤ï¸ 1
â”‚           â”‚   â”‚   â”‚   â””â”€â”€ ğŸ˜‚ 3
â”‚           â”‚   â”‚   â””â”€â”€ Hover actions
â”‚           â”‚   â”‚       â”œâ”€â”€ [ğŸ˜Š] Reaction button
â”‚           â”‚   â”‚       â””â”€â”€ [â†©ï¸] Reply button
â”‚           â”‚   â”‚
â”‚           â”‚   â””â”€â”€ Auto-scroll on new messages
â”‚           â”‚
â”‚           â””â”€â”€ MessageInput
â”‚               â”œâ”€â”€ File input (hidden)
â”‚               â”œâ”€â”€ Paperclip button [ğŸ“]
â”‚               â”œâ”€â”€ Textarea with @mention support
â”‚               â”‚   â”œâ”€â”€ @mention autocomplete dropdown
â”‚               â”‚   â”‚   â”œâ”€â”€ User 1 (full_name)
â”‚               â”‚   â”‚   â”œâ”€â”€ User 2 (email)
â”‚               â”‚   â”‚   â””â”€â”€ User N (filtered)
â”‚               â”‚   â””â”€â”€ Arrow key navigation
â”‚               â”œâ”€â”€ Send button [â¤]
â”‚               â”œâ”€â”€ File preview chips (if files selected)
â”‚               â””â”€â”€ Help text: "Type @ to mention..."
```

## State Management Flow

```
User Action
    â†“
Component Handler
    â†“
React Query Mutation
    â†“
API Route (/api/messaging/...)
    â†“
Supabase Database
    â†“
PostgreSQL Trigger (if INSERT)
    â†“
Supabase Real-time Subscription
    â†“
Query Invalidation
    â†“
Automatic Refetch
    â†“
Component Re-render
    â†“
User sees update instantly
```

## Message Flow Example

```
User A types and sends: "Hey @Alice, check this out! ğŸ“"

1. onSend() called
   - content: "Hey @Alice, check this out! ğŸ“"
   - mentionedUserIds: ["alice-uuid"]
   - attachments: [File]

2. useSendMessage mutation
   POST /api/messaging/[teamId]/[channelId]/messages
   {
     content: "Hey @Alice, check this out! ğŸ“",
     mentionedUserIds: ["alice-uuid"]
   }

3. API route processes:
   - Validates input
   - Creates message record
   - Creates mention record for Alice
   - Uploads file to storage
   - Creates attachment record
   - Returns complete message object

4. Response:
   {
     message: {
       id: "msg-123",
       channel_id: "chan-456",
       user_id: "user-a-id",
       content: "Hey @Alice, check this out! ğŸ“",
       created_at: "2025-11-11T10:30:00Z",
       author: { ... },
       attachments: [ { file_url, file_name, ... } ],
       mentions: [ { mentioned_user_id: "alice-uuid", ... } ],
       reactions: []
     }
   }

5. React Query invalidates ["messages", channelId]

6. Query auto-refetches

7. MessageList re-renders with new message

8. Supabase subscription triggers on INSERT
   - User B gets real-time notification
   - User B's query refetches
   - User B sees message instantly

9. Timeline:
   - T+0ms: User A clicks send
   - T+50ms: Message sent to API
   - T+100ms: Message stored in DB
   - T+120ms: User A sees message
   - T+150ms: User B receives via WebSocket
   - T+200ms: User B sees message
```

## Mention System Flow

```
User types in MessageInput
    â†“
Text: "Hey @al"
    â†“
useEffect triggers (on content change)
    â†“
Detect @ and capture query "al"
    â†“
extractMentions("Hey @al") â†’ ["al"]
    â†“
getMatchingUsers("al", teamMembers)
    â†“
Filter team members:
  - Alice Smith (full_name includes "al") âœ“
  - Albert Johnson (full_name includes "al") âœ“
  - Bob (doesn't match) âœ—
    â†“
Show dropdown:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ â–¸ Alice Smith        â”‚ (highlighted)
  â”‚   alice@team.com     â”‚
  â”‚                      â”‚
  â”‚   Albert Johnson     â”‚
  â”‚   albert@team.com    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
User presses â†“ arrow
    â†“
Highlight Albert Johnson
    â†“
User presses Enter
    â†“
handleSelectMention(Albert)
    â†“
Update text to: "Hey @Albert Johnson "
    â†“
Move cursor after mention
    â†“
Close dropdown
    â†“
Extract mention ID: "albert-uuid"
    â†“
When sending message:
POST /api/messaging/[teamId]/[channelId]/messages
{
  content: "Hey @Albert Johnson ",
  mentionedUserIds: ["albert-uuid"]
}
```

## File Upload Flow

```
User clicks [ğŸ“] button
    â†“
File input opens
    â†“
User selects file(s)
    â†“
handleAttachmentSelect()
    â†“
File added to state
    â†“
Preview shown above input:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Document.pdf [âœ•]             â”‚
â”‚ Resume.pdf [âœ•]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
User types message + clicks send
    â†“
useSendMessage executes
    â†“
POST /api/messaging/.../messages (without files)
    â†“
Message created
    â†“
For each file:
    POST /api/messaging/.../[messageId]/attachments
    FormData: { file: File }
        â†“
    Upload to Supabase Storage
        â†“
    Get public URL
        â†“
    Create attachment record
        â†“
    Return attachment
    â†“
Invalidate messages query
    â†“
Refetch messages
    â†“
Show attachments in message:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check this document!        â”‚
â”‚ [Document.pdf preview]      â”‚
â”‚   ğŸ“„ Document.pdf (245 KB)  â”‚
â”‚   [Download â†“]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Real-Time Update Flow

```
User A sends message
    â†“
Message INSERT in database
    â†“
PostgreSQL trigger fires
    â†“
message_channels.updated_at updated
    â†“
Supabase notify event
    â†“
WebSocket transmission
    â†“
User B's subscription receives
    â†“
Real-time hook fires
    â†“
onNewMessage callback
    â†“
invalidateQueries(['messages', channelId])
    â†“
Query client marks stale
    â†“
Automatic background refetch
    â†“
New message data fetched
    â†“
React component re-renders
    â†“
User B sees new message (total: ~100ms)

Timeline:
T+0ms: User A sends
T+10ms: DB INSERT
T+30ms: Trigger fires
T+40ms: WebSocket sent
T+80ms: User B receives
T+90ms: Query refetch
T+100ms: User B sees message
```

## Database Relationships

```
teams
  â”‚
  â”œâ”€â”€â”€â”€â”€â†’ message_channels (team_id)
  â”‚         â”‚
  â”‚         â”œâ”€â†’ message_channel_members (channel_id)
  â”‚         â”‚     â””â”€â†’ auth.users (user_id)
  â”‚         â”‚
  â”‚         â””â”€â†’ messages (channel_id)
  â”‚             â”‚
  â”‚             â”œâ”€â†’ auth.users (user_id) [author]
  â”‚             â”‚
  â”‚             â”œâ”€â†’ message_attachments (message_id)
  â”‚             â”‚
  â”‚             â”œâ”€â†’ message_mentions (message_id)
  â”‚             â”‚     â””â”€â†’ auth.users (mentioned_user_id)
  â”‚             â”‚
  â”‚             â””â”€â†’ message_reactions (message_id)
  â”‚                 â””â”€â†’ auth.users (user_id)
  â”‚
  â””â”€â†’ team_members (user_id)
```

## Keyboard Shortcuts

| Shortcut | Action |
|----------|--------|
| `@` | Trigger mention autocomplete |
| `â†‘` / `â†“` | Navigate mention suggestions |
| `Enter` | Select mention / Send message |
| `Esc` | Close mention dropdown |
| `Ctrl+Enter` | Send message |
| `Backspace` | Remove selected file |
| `Click ğŸ“` | Open file selector |
| `Hover message` | Show reaction/reply buttons |

## Color & Theme

### Light Theme
- Background: #ffffff
- Text: #000000
- Borders: #e5e7eb
- Hover: #f3f4f6
- Primary: #[accent-color]
- Muted: #6b7280

### Dark Theme
- Background: #1f2937
- Text: #f3f4f6
- Borders: #374151
- Hover: #111827
- Primary: #[accent-color]
- Muted: #9ca3af

## Responsive Breakpoints

| Breakpoint | Width | Layout |
|------------|-------|--------|
| Mobile | < 768px | Full-width, modal sidebar |
| Tablet | 768-1023px | Full-width, modal sidebar |
| Desktop | â‰¥ 1024px | Sidebar + chat (fixed width) |

---

**This visual reference helps understand the messaging system's structure, data flow, and user interactions.**
